{% load static %}
<!DOCTYPE HTML>
<html lang="en">
    <head>
        <!--=============== basic  ===============-->
        <meta charset="UTF-8">
        <title>ElegantDecor - Schedule Consultation</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="robots" content="index, follow"/>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <!--=============== css  ===============-->	
        <link type="text/css" rel="stylesheet" href="{% static 'index/css/reset.css' %}">
        <link type="text/css" rel="stylesheet" href="{% static 'index/css/plugins.css' %}">
        <link type="text/css" rel="stylesheet" href="{% static 'index/css/style.css' %}">
        <link type="text/css" rel="stylesheet" href="{% static 'index/css/dark-style.css' %}">		
        <link type="text/css" rel="stylesheet" href="{% static 'index/css/yourstyle.css' %}">
        <!--=============== favicons ===============-->
        <link rel="shortcut icon" href="{% static 'index/images/favicon.ico' %}">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css">
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
        <style>
            .fc-theme-standard {
                font-family: 'Georgia', serif;
                background-color: #f9f9f9;
            }
            .fc .fc-toolbar-title {
                font-size: 1.8em;
                font-weight: bold;
                color: #292929;
                text-transform: uppercase;
            }
            .fc .fc-button-primary {
                background-color: #292929;
                border-color: #292929;
                text-transform: uppercase;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            .fc .fc-button-primary:hover {
                background-color: #404040;
                border-color: #404040;
            }
            .fc .fc-daygrid-day-number {
                font-size: 1em;
                color: #292929;
                padding: 8px;
            }
            .fc .fc-daygrid-day-top {
                justify-content: center;
            }
            .fc .fc-day-today {
                background-color: #f0f0f0 !important;
            }
            .fc .fc-event {
                background-color: #292929;
                border: none;
                border-radius: 0;
                font-size: 0.9em;
                padding: 3px 6px;
                transition: all 0.3s ease;
            }
            .fc .fc-event:hover {
                background-color: #404040;
                transform: scale(1.05);
            }
            #calendar {
                max-width: 900px;
                margin: 0 auto;
                background-color: #fff;
                padding: 30px;
                border: 1px solid #e0e0e0;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            }
            .fc .fc-day-past {
                opacity: 0.5;
            }
            .fc .fc-day-past .fc-daygrid-day-number {
                color: #999;
            }
            .fc .fc-col-header-cell-cushion {
                padding: 10px 0;
            }
            .fc .fc-daygrid-day-frame {
                min-height: 100px;
            }
            .fc .fc-daygrid-day-events {
                margin-top: 4px;
            }
            .fc .fc-daygrid-more-link {
                color: #292929;
                font-weight: bold;
            }
            .fc-event.past-date {
                opacity: 0.5;
                pointer-events: none;
            }
            .swal2-popup {
                font-family: 'Georgia', serif;
            }
            .swal2-title {
                color: #292929;
            }
            .swal2-confirm {
                background-color: #292929 !important;
            }
            .swal2-cancel {
                background-color: #999 !important;
            }
            .fc-event {
                background-color: #292929 !important;
                border-color: #292929 !important;
                color: #fff !important;
            }
            .fc-event-title {
                font-weight: bold;
                padding: 2px 4px;
            }
            .fc-daygrid-event {
                white-space: normal !important;
                align-items: normal !important;
            }
            .fc-event-time {
                font-weight: normal;
                font-size: 0.9em;
            }
            .fc-event.booked-date {
                background-color: #FF0000 !important;
                border-color: #FF0000 !important;
                color: #fff !important;
                opacity: 0.8;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <!-- loader -->
        <div class="loader">
            <div id="movingBallG">
                <div class="movingBallLineG"></div>
                <div id="movingBallG_1" class="movingBallG"></div>
            </div>
        </div>
        <!-- loader end -->
        <!--================= Main   ================-->
        <div id="main">
            <!--================= header ================-->
            <header class="main-header">
                <!-- logo -->
                <a class="logo-holder"href="{% url 'index' %}" ><img src="{% static 'index/images/ElegantDecor.gif' %}" style="margin-left: 39%;" height="43px" alt=""></a>
                <!-- logo end -->  
                <div class="show-share-wrap">
                    <div class="show-share" style="color: #f39c12; font-weight: bold; font-size: 1.2em; position: relative; z-index: 100;">
                        <span style="display: inline-block; padding: 5px;">{{ user.username }}</span>
                    </div>
                </div>
                <!-- share button end-->  	
                <!-- mobile nav --> 
                <div class="nav-button-wrap">
                    <div class="nav-button vis-main-menu"><span></span><span></span><span></span></div>
                </div>
                <!-- mobile nav end--> 
                <!--  navigation --> 
                <div class="nav-holder">
                    <nav>
                        <ul>   
                           
                                <li>
                                    <a href="{% url 'index' %}" >Home</a>
                                </li>
                                <li>
                                    <a href="{% url 'portfolio' %}" >Designs</a>
                                </li>
                            
                                
                            <li>
                                <a href="about.html">About</a>
                                <ul>
                                    <li><a href="about-personal.html">Personal</a></li>
                                    <li><a href="services.html">Services</a></li>
                                </ul>
                            </li>
                            <li>
                                <a href="contact.html">Contacts</a>
                            </li>
                           
                            <li>
                                <a href="{% url 'consultations' %}" >Consultations</a>
                             
                            </li>
                            <li>
                                <a href="{% url 'projects_manage' %}" >Projects</a>
                             
                            </li>
                            
                        </ul>
                    </nav>
                </div>
                <!-- navigation  end -->
            </header>
            <!-- header  end -->
            <!--=============== wrapper ===============-->
            <div id="wrapper">
                <!-- content-holder  -->
                <div class="content-holder">
                    <!--  content -->
                    <div class="content">
                        <!--  section  -->
                        <section>
                            <div class="container">
                                <div class="contact-details-wrap fl-wrap" style="margin-top: -5%;">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="small-sec-title">
                                                <h3 style="font-size: 28px; color: #292929; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px;">Schedule Consultation Dates</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div id="calendar" class="animate__animated animate__fadeIn"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <!--  section end  -->
                        <!--  social-wrap  -->
                        <div class="social-wrap fl-wrap">
                            <ul>
                                <li><a href="#" target="_blank"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#" target="_blank"><i class="fa fa-twitter"></i></a></li>
                                <li><a href="#" target="_blank"><i class="fa fa-instagram"></i></a></li>
                                <li><a href="#" target="_blank"><i class="fa fa-pinterest"></i></a></li>
                                <li><a href="#" target="_blank"><i class="fa fa-tumblr"></i></a></li>
                            </ul>
                        </div>
                        <!--  social-wrap  end-->
                    </div>
                    <!-- content end -->
                    <!--=============== content-footer   ===============-->
                    <div class="height-emulator"></div>
                    <footer class="content-footer">
                        <div class="footer-inner">
                            <div class="row">
                                <div class="col-md-3">
                                    <a class="footer-logo" href="index.html"><img src="images/logo.png" alt=""></a>
                                </div>
                                <div class="col-md-4">
                                    <div class="footer-header fl-wrap"><span>01.</span> Contacts</div>
                                    <div class="footer-box fl-wrap">
                                        <ul>
                                            <li><span>Mail :</span><a href="#" target="_blank">yourmail@domain.com</a></li>
                                            <li> <span>Adress :</span><a href="#" target="_blank">USA 27TH Brooklyn NY</a></li>
                                            <li><span>Phone :</span><a href="#">+7(111)123456789</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="footer-header fl-wrap"><span>02.</span> Subscribe</div>
                                    <div class="footer-box fl-wrap">
                                        <div class="subcribe-form fl-wrap">
                                            <span>Newsletter</span>
                                            <form id="subscribe">
                                                <input class="enteremail" name="email" id="subscribe-email" placeholder="email" spellcheck="false" type="text">
                                                <button type="submit" id="subscribe-button" class="subscribe-button">Submit</button>
                                                <label for="subscribe-email" class="subscribe-message"></label>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3"></div>
                                <div class="col-md-9">
                                    <div class="fl-wrap policy-box">
                                        <p> &#169; ElegantDecor   2017.  All rights reserved.  </p>
                                    </div>
                                </div>
                            </div>
                            <div class="to-top"><i class="fa fa-long-arrow-up"></i></div>
                        </div>
                    </footer>
                    <!-- content-footer end    -->
                </div>
                <!-- content-holder end -->
            </div>
            <!-- wrapper end -->
            <!--search-form-holder -->
            <div class="search-form-holder fixed-search">
                <div class="search-form-bg"></div>
                <div class="search-form-wrap">
                    <div class="container">
                        <form class="searchform" method="get"  >
                            <input type="text" autocomplete="off"   name="s" placeholder="Type and Enter to Search">
                        </form>
                        <div class="close-fixed-search"></div>
                    </div>
                    <div class="dublicated-text"></div>
                </div>
            </div>
            <!--search-form-holder  end-->
            <div class="share-wrapper isShare">
                <div class="share-container" style="padding: 20px;">
                    <ul style="list-style-type: none; padding: 0; margin: 0;">
                       
                    <li style="margin-bottom: 15px; border-bottom: 1px solid #fff;">
                        <a href="{% url 'profile' %}" style="color: #fff; text-decoration: none; font-size: 16px; transition: all 0.3s ease; display: block; padding: 10px; border-radius: 5px;" onmouseover="this.style.backgroundColor='#fff'; this.style.color='#000';" onmouseout="this.style.backgroundColor='black'; this.style.color='#fff';">My Profile</a>
                    </li>
                        <li style="margin-bottom: 15px; border-bottom: 1px solid #fff;">
                            <a href="{% url 'add_portfolio' %}"  style="color: #fff; text-decoration: none; font-size: 16px; transition: all 0.3s ease; display: block; padding: 10px; border-radius: 5px;" onmouseover="this.style.backgroundColor='#fff'; this.style.color='#000';" onmouseout="this.style.backgroundColor='black'; this.style.color='#fff';">Add Designs</a>
                        </li>
                        <li style="margin-bottom: 15px; border-bottom: 1px solid #fff;">
                            <a href="{% url 'schedule_consultation' %}"style="color: #000; background-color: #fff; text-decoration: none; font-size: 16px; transition: all 0.3s ease; display: block; padding: 10px; border-radius: 5px;">Schedule Consultations</a>
                        </li>
                    <li style="margin-bottom: 15px; border-bottom: 1px solid #fff;">
                        <a href="{% url 'logout_view' %}" style="color: #fff; text-decoration: none; font-size: 16px; transition: all 0.3s ease; display: block; padding: 10px; border-radius: 5px;" onmouseover="this.style.backgroundColor='#fff'; this.style.color='#000';" onmouseout="this.style.backgroundColor='black'; this.style.color='#fff';">Logout</a>
                    </li>
                    </ul>
                </div>
            </div>
            <!-- Share container  end-->
            <!-- footer -->
            <footer class="main-footer">
                <div class="fixed-title"><span>Schedule Consultations</span></div>
                <div class="footer-social">
                    <ul>
                        <li><a href="#" target="_blank" ><i class="fa fa-facebook"></i></a></li>
                        <li><a href="#" target="_blank"><i class="fa fa-twitter"></i></a></li>
                        <li><a href="#" target="_blank" ><i class="fa fa-instagram"></i></a></li>
                        <li><a href="#" target="_blank" ><i class="fa fa-pinterest"></i></a></li>
                        <li><a href="#" target="_blank" ><i class="fa fa-tumblr"></i></a></li>
                    </ul>
                </div>
            </footer>
            <!-- footer end-->
        </div>
        <!-- Main end -->
        <!--=============== scripts  ===============-->
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyDwJSRi0zFjDemECmFl9JtRj1FY7TiTRRo"></script>
          <script type="text/javascript" src="{% static 'index/js/jquery.min.js' %}"></script>
            <script type="text/javascript" src="{% static 'index/js/plugins.js' %}"></script>
            <script type="text/javascript" src="{% static 'index/js/scripts.js' %}"></script>
        <script type="text/javascript" src="{% static 'index/js/map.js' %}"></script>
       
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    buttonText: {
                        today: 'Today',
                        month: 'Month',
                        week: 'Week',
                        day: 'Day'
                    },
                    selectable: true,
                    selectMirror: true,
                    select: handleDateSelection,
                    eventClick: handleEventClick,
                    events: {{ consultation_dates|safe }},
                    eventColor: '#292929',
                    eventTextColor: '#fff',
                    eventBorderColor: '#292929',
                    eventBackgroundColor: '#292929',
                    validRange: {
                        start: '2000-01-01'  // Allow past dates
                    },
                    dayMaxEventRows: true,
                    aspectRatio: 1.35,
                    slotDuration: '00:30:00',  // 30-minute slots
                    slotMinTime: '09:00:00',   // Start at 9 AM
                    slotMaxTime: '18:00:00',    // End at 6 PM
                    eventContent: function(arg) {
                        return {
                            html: `
                                <div class="fc-event-main-frame">
                                    <div class="fc-event-title-container">
                                        <div class="fc-event-title fc-sticky">${arg.event.title}</div>
                                    </div>
                                    ${arg.timeText ? `<div class="fc-event-time">${arg.timeText}</div>` : ''}
                                    ${arg.event.extendedProps.isBooked ? '<div class="fc-event-booked">Booked</div>' : ''}
                                </div>
                            `
                        };
                    },
                    eventDidMount: function(info) {
                        if (info.event.start < new Date()) {
                            info.el.classList.add('past-date');
                        }
                        if (info.event.extendedProps.isBooked) {
                            info.el.classList.add('booked-date');
                        }
                    }
                });
                calendar.render();
        
                function handleDateSelection(info) {
                    var date = info.startStr;
                    if (new Date(date) < new Date()) {
                        Swal.fire('Error', 'Cannot schedule consultations for past dates', 'error');
                        return;
                    }

                    // Get events for the selected date
                    var eventsOnDay = calendar.getEvents().filter(function(event) {
                        return event.start.toDateString() === new Date(date).toDateString();
                    });

                    Swal.fire({
                        title: 'Schedule Consultation',
                        html: `
                            <p>Select a time for the consultation on ${date}:</p>
                            <p>Note: Consultations must be at least one hour apart.</p>
                            <input type="time" id="consultation-time" min="09:00" max="18:00" step="1800" required>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#292929',
                        cancelButtonColor: '#999',
                        confirmButtonText: 'Schedule',
                        preConfirm: () => {
                            const time = document.getElementById('consultation-time').value;
                            if (!time) {
                                Swal.showValidationMessage('Please select a time');
                                return false;
                            }

                            // Check if the selected time is at least one hour apart from existing events
                            const selectedDateTime = new Date(`${date}T${time}`);
                            for (let event of eventsOnDay) {
                                const eventTime = event.start;
                                const timeDiff = Math.abs(selectedDateTime - eventTime) / 36e5; // Convert to hours
                                if (timeDiff < 1) {
                                    Swal.showValidationMessage('Consultations must be at least one hour apart');
                                    return false;
                                }
                            }

                            return time;
                        },
                        customClass: {
                            container: 'animate__animated animate__fadeIn'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const dateTime = `${date}T${result.value}:00`;
                            scheduleConsultation(dateTime, calendar);
                        }
                    });
                }
        
                function handleEventClick(info) {
                    Swal.fire({
                        title: 'Remove Consultation',
                        text: `Do you want to remove the consultation on ${info.event.start.toISOString().slice(0, 16).replace('T', ' ')}?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, remove it!',
                        customClass: {
                            container: 'animate__animated animate__fadeIn'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            removeScheduledDate(info.event.id, calendar);
                        }
                    });
                }
        
                function scheduleConsultation(dateTime, calendar) {
                    // Convert the dateTime to a Date object
                    const dateObj = new Date(dateTime);
                    
                    // Format the date as ISO string and log it
                    const isoString = dateObj.toISOString();
                    console.log("Sending dateTime:", isoString);
                    
                    fetch('{% url "schedule_consultation" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `date_time=${encodeURIComponent(isoString)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            calendar.addEvent({
                                id: isoString,  // Use the ISO string as the ID
                                title: 'Consultation',
                                start: dateObj,
                                allDay: false,
                                className: 'custom-event',
                                extendedProps: {
                                    isNew: true
                                }
                            });
                            Swal.fire({
                                title: 'Scheduled!',
                                text: data.message,
                                icon: 'success',
                                customClass: {
                                    container: 'animate__animated animate__fadeIn'
                                }
                            });
                            // Force the calendar to re-fetch events
                            calendar.refetchEvents();
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message,
                                icon: 'error',
                                customClass: {
                                    container: 'animate__animated animate__fadeIn'
                                }
                            });
                        }
                    });
                }
        
                function removeScheduledDate(dateTime, calendar) {
                    fetch('{% url "remove_scheduled_date" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `date_time=${encodeURIComponent(dateTime)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            var event = calendar.getEventById(dateTime);
                            if (event) {
                                event.remove();
                            }
                            Swal.fire({
                                title: 'Removed!',
                                text: data.message,
                                icon: 'success',
                                customClass: {
                                    container: 'animate__animated animate__fadeIn'
                                }
                            });
                            // Force the calendar to re-fetch events
                            calendar.refetchEvents();
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: data.message,
                                icon: 'error',
                                customClass: {
                                    container: 'animate__animated animate__fadeIn'
                                }
                            });
                        }
                    });
                }
            });
        </script>
    </body>
</html>